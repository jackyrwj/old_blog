---

layout: post
title: "é¡¹ç›®é—®é¢˜æ€»ç»“"
date: 2023-6-23
tags: [é¡¹ç›®]
comments: true
author: jackyrwj
toc: true

---
ä¹‹å‰å®Œæˆäº†ä¸¤ä¸ªé¡¹ç›®

é£é¸Ÿæ¥å£ï¼ˆ[https://github.com/jackyrwj/yuapi-backend](https://github.com/jackyrwj/yuapi-backend))

è¡¨æƒ…è´­ï¼ˆ[https://github.com/jackyrwj/sticker_backend](https://github.com/jackyrwj/sticker_backend)ï¼‰

åœ¨æ€»ç»“ä¸€ä¸‹é¡¹ç›®ä¸­é‡åˆ°çš„é—®é¢˜

## é£é¸Ÿæ¥å£
### è·¨åŸŸé—®é¢˜

å‰ç«¯é€šè¿‡nginx.confä¸­é…ç½®å°†/apiçš„è¯·æ±‚ç›´æ¥è½¬å‘åˆ°æœ¬æœºçš„7529ç«¯å£ï¼ˆåç«¯é¡¹ç›®ç«¯å£ï¼‰

```Java
location ^~ /api/ {
    proxy_pass http://127.0.0.1:7529/api/;
    add_header 'Access-Control-Allow-Origin' $http_origin;add_header 'Access-Control-Allow-Credentials' 'true';
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';add_header Access-Control-Allow-Headers '*';
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Allow-Origin' $http_origin;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
        add_header 'Access-Control-Max-Age' 1728000;
        add_header 'Content-Type' 'text/plain; charset=utf-8';
        add_header 'Content-Length' 0;
        return 204;
    }
}
```

åç«¯é€šè¿‡springbootæ¡†æ¶ä¸­ï¼Œå®ç°WebMvcConfigureræ¥å£addCorsMappingsæ–¹æ³•ï¼Œå…è®¸æœ¬æœºipçš„è¯·æ±‚

```Java
package com.yupi.project.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        //è®¾ç½®å…è®¸è·¨åŸŸçš„è·¯å¾„
        registry.addMapping("/**")
                //è®¾ç½®å…è®¸è·¨åŸŸè¯·æ±‚çš„åŸŸå
                //å½“**Credentialsä¸ºtrueæ—¶ï¼Œ**Originä¸èƒ½ä¸ºæ˜Ÿå·ï¼Œéœ€ä¸ºå…·ä½“çš„ipåœ°å€ã€å¦‚æœæ¥å£ä¸å¸¦cookie,ipæ— éœ€è®¾æˆå…·ä½“ipã€‘
                .allowedOrigins("*") //æ­¤å¤„æ˜¯æœ¬æœºçš„ip
                //æ˜¯å¦å…è®¸è¯ä¹¦ ä¸å†é»˜è®¤å¼€å¯
                .allowCredentials(true)
                //è®¾ç½®å…è®¸çš„æ–¹æ³•
                .allowedMethods("*")
                //è·¨åŸŸå…è®¸æ—¶é—´
                .maxAge(3600);
    }
}


```


## è¡¨æƒ…è´­

### 1.GEOADDå‘½ä»¤æ— æ³•ä½¿ç”¨

![](https://raw.githubusercontent.com/jackyrwj/picb/master/20230601092430.png)

åŸå› æ˜¯redisç‰ˆæœ¬çš„é—®é¢˜ï¼ŒGEOåŠŸèƒ½æ˜¯åœ¨redis3.2å‡ºæ¥çš„

> ç™»å½•å®¢æˆ·ç«¯åä½¿ç”¨å‘½ä»¤"info server" æ‰“å°redisæœåŠ¡ç«¯ç‰ˆæœ¬

![img.png](img.png)

### 2.gitignoreå¤±æ•ˆ

é¡¹ç›®çš„å‰ç«¯ä¸­å›¾ç‰‡æ–‡ä»¶å¤¹æ— éœ€ä¸Šä¼ ï¼Œé…ç½®gitignoreåå‘ç°å¹¶ä¸ºç”Ÿæ•ˆï¼Œä¸€é¡¿æ‘¸ç´¢æ—¶å€™å‘ç°ï¼š

é¡¹ç›®åˆå§‹åŒ–å .gitignoreéœ€è¦å…ˆcommitä¸€æ¬¡ï¼Œåé¢çš„æ‰èƒ½æ‰«ææ–‡ä»¶å¤¹

![](https://raw.githubusercontent.com/jackyrwj/picb/master/20230601093108.png)

### 3. git commitåï¼Œæ’¤é”€commitå¤±è´¥

æ­£å¸¸æ¥è¯´ï¼Œæ™®é€šçš„æ’¤é”€ ä½¿ç”¨å‘½ä»¤ï¼š

```Java
git reset --soft HEAD^
```

HEAD^ è¡¨ç¤ºä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œå³ä¸Šä¸€æ¬¡çš„commitï¼Œä¹Ÿå¯ä»¥å†™æˆHEAD~1

å¦‚æœè¿›è¡Œä¸¤æ¬¡çš„commitï¼Œæƒ³è¦éƒ½æ’¤å›ï¼Œå¯ä»¥ä½¿ç”¨HEAD~2

ä¸åˆ é™¤å·¥ä½œç©ºé—´çš„æ”¹åŠ¨ä»£ç  ï¼Œæ’¤é”€commitï¼Œä¸æ’¤é”€addï¼Œä½¿ç”¨--soft

åˆ é™¤å·¥ä½œç©ºé—´çš„æ”¹åŠ¨ä»£ç ï¼Œæ’¤é”€commitä¸”æ’¤é”€addï¼Œä½¿ç”¨--hard

å¦å¤–ä¸€ç‚¹ï¼Œå¦‚æœcommitæ³¨é‡Šå†™é”™äº†ï¼Œå…ˆè¦æ”¹ä¸€ä¸‹æ³¨é‡Šï¼Œæœ‰å…¶ä»–æ–¹æ³•ä¹Ÿèƒ½å®ç°ï¼Œå¦‚ï¼š

```text
git commit --amend
```

ä½†æ˜¯â—â—â—ï¼Œå¦‚æœç¬¬ä¸€æ¬¡commitï¼Œç”¨ä¸Šè¿°æ–¹æ³•æ˜¯æ— æ³•æ’¤é”€çš„ï¼Œå¯ä»¥ä½¿ç”¨

```Java
git update-ref -d HEAD
```

å‘½ä»¤æ¥å®ç°æƒ³è¦çš„æ•ˆæœã€‚å°è¯•è¿‡åï¼Œå‘ç°commitè¢«æˆåŠŸæ’¤é”€ï¼Œä»ç„¶ä¿ç•™äº†addåçš„ç»“æœã€‚

æµ‹è¯•äº†å¥½å¤šæ¬¡commitæ‰è§£å†³ ğŸ˜­

![](https://raw.githubusercontent.com/jackyrwj/picb/master/20230601093915.png)

### 4.Redisçº¿ä¸Šæ•°æ®åŒæ­¥å¤±è´¥

â—â—â— å®å¡”é¢æ¿è‡ªå¸¦çš„redisä¸‹dump.rdbä¸åœ¨é»˜è®¤è·¯å¾„ä¸‹ï¼Œå°†æœ¬åœ°æ•°æ®åŒæ­¥åˆ°çº¿ä¸Šçš„æ—¶å€™è¦æ³¨æ„ï¼ˆæ²‰ç—›æ•™è®­ğŸ˜­ï¼Œredisæ‰˜ç®¡å®¹æ˜“åŸ‹å‘ï¼‰

![](https://raw.githubusercontent.com/jackyrwj/picb/master/20230603101312.png)

å¦å¤–åœ¨ä½¿ç”¨redisæ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œçº¿ä¸Šåˆ«å¿˜è®°ä¹Ÿè¦å…ˆå»ºå¥½æ¶ˆæ¯é˜Ÿåˆ—

```Java
XGROUP CREATE stream.orders g1 0 MKSTREAM
```

### 5.æ‹¦æˆªå™¨é”™è¯¯

Springbootæ¡†æ¶ä¸­é€šè¿‡å®ç°WebMvcConfigureræ¥å£ä¸­çš„addInterceptorsæ¥å®ç°æ‹¦æˆªå™¨çš„æ•ˆæœï¼Œ

æœ‰æ­£å‘æ‹¦æˆª(addPathPatterns)å’Œåå‘æ‹¦æˆª(excludePathPatterns),å®é™…ä½¿ç”¨æ¥åå‘æ‹¦æˆªå¾ˆæœ‰å¯èƒ½ç¿»è½¦ï¼Œ

å› ä¸ºé…ç½®çš„æ˜¯"ä¸æ‹¦æˆª"çš„ï¼Œå¾ˆæœ‰å¯èƒ½å¤§éƒ¨åˆ†æ­£å¸¸çš„é¡µé¢ä¼šè¢«æ‹¦æˆªï¼Œ

â—â—â— å¦å¤–,å³ä½¿é…ç½®äº†è¿”å›çš„æ˜¯401"æ— æƒé™",ä½†ä¼šè¢«æµè§ˆå™¨è¯†åˆ«æˆè·¨åŸŸï¼ˆè¿˜ä¸çŸ¥é“å¯¼è‡´çš„ï¼‰

æœ€åè¿˜æ˜¯é€šè¿‡æ­£å‘æ‹¦æˆªè§£å†³äº†orzã€‚

```Java
public class MvcConfig implements WebMvcConfigurer {

    @Resource
    private StringRedisTemplate stringRedisTemplate;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // ç™»å½•æ‹¦æˆªå™¨
//        registry.addInterceptor(new LoginInterceptor())
//                .excludePathPatterns(
//                        "/shop/**",
//                        "/voucher/**",
//                        "/shop-type/**",
//                        "/upload/**",
//                        "/blog/hot",
//                        "/user/code",
//                        "/user/login"
//                ).order(1);
        registry.addInterceptor(new LoginInterceptor())
                .addPathPatterns(
                        "/follow/**/**", 
                        "/voucher-order/**"
                ).order(1);
        // tokenåˆ·æ–°çš„æ‹¦æˆªå™¨
        registry.addInterceptor(new RefreshTokenInterceptor(stringRedisTemplate)).addPathPatterns("/**").order(0);
    }
}
```

```

